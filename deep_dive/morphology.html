
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Deep Dive: Neuron Morphology Analysis &#8212; CRANTpy Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'deep_dive/morphology';</script>
    <link rel="icon" href="../_static/logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deep Dive: Analyzing Connectivity" href="connectivity.html" />
    <link rel="prev" title="Deep Dive: Plotting Neurons" href="visualization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">ðŸ“š Tutorials available! Check out the Deep Dive Gallery.</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="CRANTpy Documentation - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="CRANTpy Documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation &amp; Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Quickstart Tutorial</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Deep Dive</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="advanced_queries.html">Advanced Neuron Querying</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Plotting Neurons</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Working with Neuron Morphology</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectivity.html">Analyzing Connectivity</a></li>
<li class="toctree-l1"><a class="reference internal" href="segmentation.html">Using EM Segmentation Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="ngllink.html">From CRANTpy to Neuroglancer</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/modules.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/crantpy.html">crantpy package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/crantpy.queries.html">crantpy.queries package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.queries.connections.html">crantpy.queries.connections module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.queries.neurons.html">crantpy.queries.neurons module</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/crantpy.utils.html">crantpy.utils package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.cave.html">crantpy.utils.cave package</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.config.html">crantpy.utils.config module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.decorators.html">crantpy.utils.decorators module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.exceptions.html">crantpy.utils.exceptions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.helpers.html">crantpy.utils.helpers module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.neuroglancer.html">crantpy.utils.neuroglancer module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.seatable.html">crantpy.utils.seatable module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.utils.types.html">crantpy.utils.types module</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/crantpy.viz.html">crantpy.viz package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.viz.l2.html">crantpy.viz.l2 module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.viz.mesh.html">crantpy.viz.mesh module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/crantpy.viz.skeletonize.html">crantpy.viz.skeletonize module</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">Acknowledgements</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/Social-Evolution-and-Behavior/crantpy/main?urlpath=lab/tree/docs/deep_dive/morphology.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/Social-Evolution-and-Behavior/crantpy/blob/main/docs/deep_dive/morphology.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Social-Evolution-and-Behavior/crantpy" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Social-Evolution-and-Behavior/crantpy/edit/main/docs/deep_dive/morphology.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Social-Evolution-and-Behavior/crantpy/issues/new?title=Issue%20on%20page%20%2Fdeep_dive/morphology.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/deep_dive/morphology.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Deep Dive: Neuron Morphology Analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-setup">1. Authentication Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-sample-neurons">2. Getting Sample Neurons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mesh-representations">3. Mesh Representations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-mesh-neurons">Fetching Mesh Neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soma-detection">Soma Detection</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#skeleton-representations">4. Skeleton Representations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precomputed-skeletons">Precomputed Skeletons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l2-graph-based-skeletons">L2 Graph-Based Skeletons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l2-information-and-statistics">L2 Information and Statistics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-anchor-locations">Finding Anchor Locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rerooting-skeletons-to-the-soma">Rerooting Skeletons to the Soma</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#utility-functions-for-spatial-operations">Utility Functions for Spatial Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dotprops-point-cloud-representations">5. Dotprops - Point Cloud Representations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#morphometric-analysis">6. Morphometric Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-morphometrics">Basic Morphometrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-level-morphological-analysis">Population-Level Morphological Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-cell-types">Comparing Cell Types</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-navis-integration">7. Advanced Navis Integration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling">Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothing">Smoothing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trim-branches">Trim branches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#neuron-similarity-nblast">Neuron Similarity (NBLAST)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-calculations">8. Distance Calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-rate-node-to-parent-distances">Sampling Rate (Node-to-Parent Distances)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-single-node-to-node-query">Geodesic Distance: Single Node-to-Node Query</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-matrix">Geodesic Distance Matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-node-coloring">Distance-based Node Coloring</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-morphometric-analysis">9. Advanced Morphometric Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#segment-analysis">Segment Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-node-properties">Visualizing Node Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sholl-analysis">Sholl analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#euclidean-distance-from-soma">Euclidean distance from soma</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-from-soma">Geodesic distance from soma</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="deep-dive-neuron-morphology-analysis">
<h1>Deep Dive: Neuron Morphology Analysis<a class="headerlink" href="#deep-dive-neuron-morphology-analysis" title="Link to this heading">#</a></h1>
<p>This comprehensive tutorial explores the morphological analysis capabilities of CRANTpy. Weâ€™ll cover:</p>
<ul class="simple">
<li><p><strong>Mesh representations</strong> - Fetching and analyzing neuron meshes</p></li>
<li><p><strong>Skeleton representations</strong> - Multiple skeletonization methods</p></li>
<li><p><strong>L2 graph-based skeletons</strong> - High-quality morphology from L2 chunks</p></li>
<li><p><strong>Dotprops</strong> - Point cloud representations for fast analysis</p></li>
<li><p><strong>Morphometric analysis</strong> - Cable length, surface area, volume, branching</p></li>
<li><p><strong>Soma detection</strong> - Automated soma identification</p></li>
<li><p><strong>Visualization</strong> - 2D and 3D visualization techniques</p></li>
<li><p><strong>Population analysis</strong> - Comparing morphology across neuron groups</p></li>
<li><p><strong>Navis integration</strong> - Leveraging navis for advanced analysis</p></li>
</ul>
<p>Letâ€™s start by setting up our environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import CRANTpy and other necessary libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">crantpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">navis</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cloudvolume</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>

<span class="c1"># Set up logging</span>
<span class="n">cp</span><span class="o">.</span><span class="n">set_logging_level</span><span class="p">(</span><span class="s2">&quot;WARNING&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CRANTpy loaded successfully!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default dataset: </span><span class="si">{</span><span class="n">cp</span><span class="o">.</span><span class="n">CRANT_DEFAULT_DATASET</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Navis version: </span><span class="si">{</span><span class="n">navis</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CRANTpy loaded successfully!
Default dataset: latest
Navis version: 1.10.0
</pre></div>
</div>
</div>
</div>
<section id="authentication-setup">
<h2>1. Authentication Setup<a class="headerlink" href="#authentication-setup" title="Link to this heading">#</a></h2>
<p>First, ensure you are authenticated with the CAVE service.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate and save authentication token (uncomment if first time)</span>
<span class="c1"># cp.generate_cave_token(save=True)</span>

<span class="c1"># Test connection</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_cave_client</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully connected to datastack: </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">datastack_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server: </span><span class="si">{</span><span class="n">client</span><span class="o">.</span><span class="n">server_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please run: cp.generate_cave_token(save=True)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully connected to datastack: kronauer_ant
Server: https://proofreading.zetta.ai
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-sample-neurons">
<h2>2. Getting Sample Neurons<a class="headerlink" href="#getting-sample-neurons" title="Link to this heading">#</a></h2>
<p>Letâ€™s query some neurons for our morphology analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a sample of olfactory projection neurons</span>
<span class="n">opn_criteria</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">NeuronCriteria</span><span class="p">(</span><span class="n">cell_class</span><span class="o">=</span><span class="s1">&#39;olfactory_projection_neuron&#39;</span><span class="p">)</span>
<span class="n">opn_ids</span> <span class="o">=</span> <span class="n">opn_criteria</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">opn_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> olfactory projection neurons&quot;</span><span class="p">)</span>

<span class="c1"># Select a few for detailed analysis</span>
<span class="n">sample_ids</span> <span class="o">=</span> <span class="n">opn_ids</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample neurons for detailed analysis:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neuron_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">neuron_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 107 olfactory projection neurons

Sample neurons for detailed analysis:
  1. 576460752700282748
  2. 576460752681552812
  3. 576460752722405178
</pre></div>
</div>
</div>
</div>
</section>
<section id="mesh-representations">
<h2>3. Mesh Representations<a class="headerlink" href="#mesh-representations" title="Link to this heading">#</a></h2>
<p>Meshes provide the most detailed representation of neuron morphology, capturing the full 3D surface.</p>
<section id="fetching-mesh-neurons">
<h3>Fetching Mesh Neurons<a class="headerlink" href="#fetching-mesh-neurons" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch a single mesh neuron</span>
<span class="n">single_mesh</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_mesh_neuron</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mesh neuron properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ID: </span><span class="si">{</span><span class="n">single_mesh</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Vertices: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">single_mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Faces: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">single_mesh</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Volume: </span><span class="si">{</span><span class="n">single_mesh</span><span class="o">.</span><span class="n">volume</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> cubic nanometers&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mesh neuron properties:
  ID: 576460752700282748
  Vertices: 238,432
  Faces: 478,609
  Volume: 135639679325.33 cubic nanometers
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch multiple mesh neurons</span>
<span class="n">mesh_neurons</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_mesh_neuron</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mesh_neurons</span><span class="p">)</span><span class="si">}</span><span class="s2"> mesh neurons&quot;</span><span class="p">)</span>

<span class="c1"># Summary of meshes</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">mesh_neurons</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> vertices, </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">volume</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼mÂ³&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bb4408e31c4b446880a4a8e4d4d61c11", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fetched 3 mesh neurons
  576460752700282748: 238,432 vertices, 135639679325.33 Î¼mÂ³
  576460752681552812: 309,633 vertices, 192266769082.67 Î¼mÂ³
  576460752722405178: 248,290 vertices, 154247730149.33 Î¼mÂ³
  576460752681552812: 309,633 vertices, 192266769082.67 Î¼mÂ³
  576460752722405178: 248,290 vertices, 154247730149.33 Î¼mÂ³
</pre></div>
</div>
</div>
</div>
</section>
<section id="soma-detection">
<h3>Soma Detection<a class="headerlink" href="#soma-detection" title="Link to this heading">#</a></h3>
<p>We can use the function <code class="docutils literal notranslate"><span class="pre">detect_soma</span></code> to retrieve the estimated pixel coordinates of a neuronâ€™s soma. We can then use a helper function to visually inspect this area in the raw EM data to verify it contains a nucleus.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Detect soma for a single neuron</span>
<span class="n">soma_coords</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">detect_soma</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Soma detected at coordinates: </span><span class="si">{</span><span class="n">soma_coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Detect soma for multiple neurons</span>
<span class="n">soma_coords_batch</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">detect_soma</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Soma coordinates for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> neurons:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">neuron_id</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">soma_coords_batch</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">neuron_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "53153c72db064bb4a8bdfc7caf3cfaf0", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Soma detected at coordinates: [37390 31256  1417]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:   0%|          | 0/3 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "aa5e0dbaf0494f2b9b85057d8f5f4612", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:  33%|â–ˆâ–ˆâ–ˆâ–Ž      | 1/3 [00:05&lt;00:10,  5.05s/it]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "4071b81fb9d1432b98552778eecc64a7", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:  67%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹   | 2/3 [00:11&lt;00:06,  6.03s/it]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3601b6b2dd4c42829bbcf0e8f5bc7b77", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                             
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Soma coordinates for 3 neurons:
  576460752700282748: [37390 31256  1417]
  576460752681552812: [36850 28930  1992]
  576460752722405178: [36203 31436  2038]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot EM image around the detected somas</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">soma_coords_batch</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">plot_em_image</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Soma at (</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 11/11 [00:00&lt;00:00, 12.60it/s]
Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 11/11 [00:00&lt;00:00, 12.60it/s]
Decompressing: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 25/25 [00:00&lt;00:00, 1637.84it/s]
Shard Indices:   0%|          | 0/4 [00:00&lt;?, ?it/s]
Shard Indices: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:00&lt;00:00, 33.11it/s]

Minishard Indices: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:00&lt;00:00, 34.10it/s]
Minishard Indices: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 4/4 [00:00&lt;00:00, 34.10it/s]
Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 10/10 [00:00&lt;00:00, 16.33it/s]
Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 10/10 [00:00&lt;00:00, 16.33it/s]
Decompressing: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 20/20 [00:00&lt;00:00, 1424.79it/s]

Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 11/11 [00:00&lt;00:00, 12.45it/s]
Downloading Bundles: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 11/11 [00:00&lt;00:00, 12.45it/s]
Decompressing: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 25/25 [00:00&lt;00:00, 1049.49it/s]
</pre></div>
</div>
<img alt="../_images/b043fd314daccddaf1e3ae918f68a2c59e550551d45c8e905acb290cc4a98333.png" src="../_images/b043fd314daccddaf1e3ae918f68a2c59e550551d45c8e905acb290cc4a98333.png" />
</div>
</div>
<p>We can also plot the soma location on the mesh, but for this we need to convert from pixels coordinates to nanometers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">crantpy.utils.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">SCALE_X</span><span class="p">,</span> <span class="n">SCALE_Y</span><span class="p">,</span> <span class="n">SCALE_Z</span>
<span class="n">scaling_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">SCALE_X</span><span class="p">,</span> <span class="n">SCALE_Y</span><span class="p">,</span> <span class="n">SCALE_Z</span><span class="p">])</span>  <span class="c1"># in microns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="c1"># scale soma coordinates to nanometers</span>
    <span class="n">soma_nm</span> <span class="o">=</span> <span class="p">[</span><span class="n">soma_coords_batch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">SCALE_X</span><span class="p">,</span> <span class="n">soma_coords_batch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">SCALE_Y</span><span class="p">,</span> <span class="n">soma_coords_batch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">SCALE_Z</span><span class="p">]</span>
    <span class="c1"># get the mesh</span>
    <span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh_neurons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># plot the mesh with soma location</span>
    <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkcyan&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">soma_nm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">soma_nm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Soma at (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">soma_nm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">soma_nm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">soma_nm</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="si">}</span><span class="s2">) nm&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2ae0beadf473ade1d446d525f746300c7e6ae7a19d33c55018358af3dd981d08.png" src="../_images/2ae0beadf473ade1d446d525f746300c7e6ae7a19d33c55018358af3dd981d08.png" />
</div>
</div>
</section>
</section>
<section id="skeleton-representations">
<h2>4. Skeleton Representations<a class="headerlink" href="#skeleton-representations" title="Link to this heading">#</a></h2>
<p>Skeletons are tree-like representations that capture the branching structure of neurons while being much more computationally efficient than meshes.</p>
<section id="precomputed-skeletons">
<h3>Precomputed Skeletons<a class="headerlink" href="#precomputed-skeletons" title="Link to this heading">#</a></h3>
<p>CRANTpy provides access to precomputed skeletons stored in the database.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch precomputed skeletons</span>
<span class="n">skeletons</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_skeletons</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">omit_failures</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">skeletons</span><span class="p">)</span><span class="si">}</span><span class="s2"> skeletons&quot;</span><span class="p">)</span>

<span class="c1"># Examine first skeleton</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skeletons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">skel</span> <span class="o">=</span> <span class="n">skeletons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Skeleton </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> properties:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Nodes: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">n_nodes</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cable length: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Branch points: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">n_branch_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  End points: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">n_endpoints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fetched 3 skeletons

Skeleton 576460752700282748 properties:
  Nodes: 221
  Cable length: 1075895.12 nm
  Branch points: 0
  End points: None
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="l2-graph-based-skeletons">
<h3>L2 Graph-Based Skeletons<a class="headerlink" href="#l2-graph-based-skeletons" title="Link to this heading">#</a></h3>
<p>For higher quality morphology, CRANTpy can generate skeletons from L2 chunks. These are often more accurate than precomputed skeletons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get L2 skeleton for a single neuron</span>
<span class="n">l2_skel</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_skeleton</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L2 skeleton properties:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Nodes: </span><span class="si">{</span><span class="n">l2_skel</span><span class="o">.</span><span class="n">n_nodes</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cable length: </span><span class="si">{</span><span class="n">l2_skel</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Branch points: </span><span class="si">{</span><span class="n">l2_skel</span><span class="o">.</span><span class="n">n_branch_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  End points: </span><span class="si">{</span><span class="n">l2_skel</span><span class="o">.</span><span class="n">n_endpoints</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>L2 skeleton properties:
  Nodes: 309
  Cable length: 1409182.00 nm
  Branch points: 55
  End points: None
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get L2 skeletons for multiple neurons</span>
<span class="n">l2_skels</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_skeleton</span><span class="p">(</span>
    <span class="n">sample_ids</span><span class="p">,</span>
    <span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">max_threads</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">omit_failures</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">)</span><span class="si">}</span><span class="s2"> L2 skeletons&quot;</span><span class="p">)</span>

<span class="c1"># Compare with precomputed skeletons</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skeletons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparison (first neuron):&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Precomputed: </span><span class="si">{</span><span class="n">skeletons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  L2-based:    </span><span class="si">{</span><span class="n">l2_skels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "87c2e41997ba4c218bad02eb06ee6d53", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fetched 3 L2 skeletons

Comparison (first neuron):
  Precomputed: 1075895.12 nm
  L2-based:    1409182.00 nm
</pre></div>
</div>
</div>
</div>
</section>
<section id="l2-information-and-statistics">
<h3>L2 Information and Statistics<a class="headerlink" href="#l2-information-and-statistics" title="Link to this heading">#</a></h3>
<p>You can query L2 chunk information directly for fast morphology estimates. Note that the <code class="docutils literal notranslate"><span class="pre">length_um</span></code> is an underestimated sum of max diameters across L2 chunks, not a full cable length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get L2 info (fast estimate of morphology)</span>
<span class="n">l2_info</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_info</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L2 chunk information:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">l2_info</span><span class="p">[[</span><span class="s1">&#39;root_id&#39;</span><span class="p">,</span> <span class="s1">&#39;l2_chunks&#39;</span><span class="p">,</span> <span class="s1">&#39;length_um&#39;</span><span class="p">,</span> <span class="s1">&#39;chunks_missing&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                               
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>L2 chunk information:
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>root_id</th>
      <th>l2_chunks</th>
      <th>length_um</th>
      <th>chunks_missing</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>576460752700282748</td>
      <td>309</td>
      <td>39.526</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>576460752722405178</td>
      <td>377</td>
      <td>45.559</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>576460752681552812</td>
      <td>390</td>
      <td>53.886</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get detailed L2 chunk info</span>
<span class="n">l2_chunk_info</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_chunk_info</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Detailed L2 chunk info for neuron </span><span class="si">{</span><span class="n">sample_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total chunks: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">l2_chunk_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Columns: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">l2_chunk_info</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">l2_chunk_info</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ea842a58e14240b5b8f66c1e1e4d890e", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detailed L2 chunk info for neuron 576460752700282748:
  Total chunks: 309
  Columns: [&#39;root_id&#39;, &#39;l2_id&#39;, &#39;x&#39;, &#39;y&#39;, &#39;z&#39;, &#39;vec_x&#39;, &#39;vec_y&#39;, &#39;vec_z&#39;, &#39;size_nm3&#39;]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>root_id</th>
      <th>l2_id</th>
      <th>x</th>
      <th>y</th>
      <th>z</th>
      <th>vec_x</th>
      <th>vec_y</th>
      <th>vec_z</th>
      <th>size_nm3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>576460752700282748</td>
      <td>145804519643567814</td>
      <td>27616</td>
      <td>9700</td>
      <td>2815</td>
      <td>0.404541</td>
      <td>0.913086</td>
      <td>0.054138</td>
      <td>138808320</td>
    </tr>
    <tr>
      <th>1</th>
      <td>576460752700282748</td>
      <td>145804519710680256</td>
      <td>27586</td>
      <td>9700</td>
      <td>2816</td>
      <td>-0.446289</td>
      <td>0.60791</td>
      <td>0.656738</td>
      <td>483076608</td>
    </tr>
    <tr>
      <th>2</th>
      <td>576460752700282748</td>
      <td>145804588430144816</td>
      <td>27138</td>
      <td>10418</td>
      <td>3038</td>
      <td>-0.220215</td>
      <td>0.436035</td>
      <td>0.872559</td>
      <td>1065555456</td>
    </tr>
    <tr>
      <th>3</th>
      <td>576460752700282748</td>
      <td>145804588497240618</td>
      <td>27602</td>
      <td>11262</td>
      <td>3151</td>
      <td>0.640625</td>
      <td>0.618652</td>
      <td>0.455078</td>
      <td>568780800</td>
    </tr>
    <tr>
      <th>4</th>
      <td>576460752700282748</td>
      <td>145804657216724259</td>
      <td>27596</td>
      <td>11264</td>
      <td>3151</td>
      <td>0.862305</td>
      <td>0.304199</td>
      <td>0.405029</td>
      <td>333666816</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="finding-anchor-locations">
<h3>Finding Anchor Locations<a class="headerlink" href="#finding-anchor-locations" title="Link to this heading">#</a></h3>
<p>Find representative coordinates (in pixels) for neurons (useful for annotations or quick localization).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find anchor locations</span>
<span class="n">anchor_locs</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">find_anchor_loc</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Anchor locations:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">anchor_locs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "613e0496b10248fc81615c8d6eed20e2", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Anchor locations:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>root_id</th>
      <th>x</th>
      <th>y</th>
      <th>z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>576460752700282748</td>
      <td>37256</td>
      <td>31210</td>
      <td>1415</td>
    </tr>
    <tr>
      <th>1</th>
      <td>576460752681552812</td>
      <td>36862</td>
      <td>29080</td>
      <td>1987</td>
    </tr>
    <tr>
      <th>2</th>
      <td>576460752722405178</td>
      <td>36214</td>
      <td>31498</td>
      <td>2047</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="rerooting-skeletons-to-the-soma">
<h3>Rerooting Skeletons to the Soma<a class="headerlink" href="#rerooting-skeletons-to-the-soma" title="Link to this heading">#</a></h3>
<p>By default, skeletons may not be rooted at the soma. We can reroot them using the detected soma location with the <code class="docutils literal notranslate"><span class="pre">reroot_at_soma()</span></code> utility function.</p>
<section id="utility-functions-for-spatial-operations">
<h4>Utility Functions for Spatial Operations<a class="headerlink" href="#utility-functions-for-spatial-operations" title="Link to this heading">#</a></h4>
<p>CRANTpy provides convenient utility functions for common spatial operations on skeletons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. map_position_to_node - Find the nearest skeleton node to any position</span>
<span class="n">position_nm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">240000</span><span class="p">,</span> <span class="mi">85000</span><span class="p">,</span> <span class="mi">96000</span><span class="p">]</span>  <span class="c1"># Position in nanometers</span>
<span class="n">node_id</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">map_position_to_node</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position_nm</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Position </span><span class="si">{</span><span class="n">position_nm</span><span class="si">}</span><span class="s2"> maps to node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Can also get the distance</span>
<span class="n">node_id</span><span class="p">,</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">map_position_to_node</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">position_nm</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance to nearest node: </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm (</span><span class="si">{</span><span class="n">distance</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m)&quot;</span><span class="p">)</span>

<span class="c1"># 2. reroot_at_soma - Automatically detect soma and reroot</span>
<span class="c1"># (We already used this above, but here&#39;s how to use it without pre-detected soma)</span>
<span class="n">skel_copy</span> <span class="o">=</span> <span class="n">l2_skels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">skel_rerooted</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">reroot_at_soma</span><span class="p">(</span><span class="n">skel_copy</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Skeleton rerooted at node </span><span class="si">{</span><span class="n">skel_rerooted</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 3. Practical example: Map synapse positions to skeleton nodes</span>
<span class="c1"># This is useful for synapse-to-skeleton mapping (as used in attach_synapses)</span>
<span class="n">synapse_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">242896</span><span class="p">,</span> <span class="mi">85536</span><span class="p">,</span> <span class="mi">96306</span><span class="p">]</span>  <span class="c1"># Example synapse coordinate in nm</span>
<span class="n">synapse_node</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">map_position_to_node</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">synapse_position</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Synapse at </span><span class="si">{</span><span class="n">synapse_position</span><span class="si">}</span><span class="s2"> would map to node </span><span class="si">{</span><span class="n">synapse_node</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Position [240000, 85000, 96000] maps to node 11
Distance to nearest node: 6027.00 nm (6.03 Î¼m)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "e5b9799948f8475881af8acf94df9d83", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Skeleton rerooted at node 223

Synapse at [242896, 85536, 96306] would map to node 11
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reroot skeletons at soma location using the convenience function</span>
<span class="c1"># This automatically detects soma and reroots at the nearest node</span>
<span class="n">l2_skels_rerooted</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">reroot_at_soma</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rerooting results:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">original</span><span class="p">,</span> <span class="n">rerooted</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l2_skels</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">l2_skels_rerooted</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Neuron </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: root changed from </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">rerooted</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:   0%|          | 0/3 [00:00&lt;?, ?it/s]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "40037d818648459eb0fbb4424d8370ab", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:  33%|â–ˆâ–ˆâ–ˆâ–Ž      | 1/3 [00:05&lt;00:11,  5.61s/it]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "95afe041ca0a4f1aa9f60c33c47e2503", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detecting soma:  67%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‹   | 2/3 [00:13&lt;00:07,  7.06s/it]
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b7a771e2d2c444cfb41761bd240209d2", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                             
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "2680002abe2b43e6b07a1884d55c9fa8", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rerooting results:
Neuron 576460752700282748: root changed from 0 to 223
Neuron 576460752681552812: root changed from 0 to 276
Neuron 576460752722405178: root changed from 0 to 239
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="dotprops-point-cloud-representations">
<h2>5. Dotprops - Point Cloud Representations<a class="headerlink" href="#dotprops-point-cloud-representations" title="Link to this heading">#</a></h2>
<p>Dotprops are lightweight point cloud representations with tangent vectors, ideal for NBLAST comparisons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate dotprops from L2 chunks</span>
<span class="n">dotprops</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_dotprops</span><span class="p">(</span>
    <span class="n">sample_ids</span><span class="p">,</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">omit_failures</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dotprops</span><span class="p">)</span><span class="si">}</span><span class="s2"> dotprops&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dotprops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">dp</span> <span class="o">=</span> <span class="n">dotprops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Dotprop </span><span class="si">{</span><span class="n">dp</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> properties:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Has vectors: </span><span class="si">{</span><span class="n">dp</span><span class="o">.</span><span class="n">vect</span><span class="w"> </span><span class="ow">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="kc">None</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "43605041468f4e0eb5b665c1aeeb8555", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "96d2a57f40ad4b30b7eba00dc2470e51", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "62795c72b42d471f98964e311bf72656", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generated 3 dotprops

Dotprop 576460752700282748 properties:
  Points: 241
  Has vectors: True
</pre></div>
</div>
</div>
</div>
</section>
<section id="morphometric-analysis">
<h2>6. Morphometric Analysis<a class="headerlink" href="#morphometric-analysis" title="Link to this heading">#</a></h2>
<p>Navis provides extensive morphometric analysis capabilities. Letâ€™s explore key metrics.</p>
<section id="basic-morphometrics">
<h3>Basic Morphometrics<a class="headerlink" href="#basic-morphometrics" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use L2 skeletons for morphometric analysis</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">morphometrics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">skel</span> <span class="ow">in</span> <span class="n">l2_skels_rerooted</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;root_id&#39;</span><span class="p">:</span> <span class="n">skel</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;cable_length_nm&#39;</span><span class="p">:</span> <span class="n">skel</span><span class="o">.</span><span class="n">cable_length</span><span class="p">,</span>
            <span class="s1">&#39;n_nodes&#39;</span><span class="p">:</span> <span class="n">skel</span><span class="o">.</span><span class="n">n_nodes</span><span class="p">,</span>
            <span class="s1">&#39;n_branch_points&#39;</span><span class="p">:</span> <span class="n">skel</span><span class="o">.</span><span class="n">n_branch_points</span><span class="p">,</span>
            <span class="s1">&#39;n_endpoints&#39;</span><span class="p">:</span> <span class="n">skel</span><span class="o">.</span><span class="n">n_endpoints</span><span class="p">,</span>
            <span class="s1">&#39;n_branches&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">skel</span><span class="o">.</span><span class="n">small_segments</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">morphometrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    
    <span class="n">morph_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">morphometrics</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic morphometrics:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">morph_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Basic morphometrics:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>root_id</th>
      <th>cable_length_nm</th>
      <th>n_nodes</th>
      <th>n_branch_points</th>
      <th>n_endpoints</th>
      <th>n_branches</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>576460752700282748</td>
      <td>1409182.000</td>
      <td>309</td>
      <td>55</td>
      <td>None</td>
      <td>152</td>
    </tr>
    <tr>
      <th>1</th>
      <td>576460752681552812</td>
      <td>1831399.000</td>
      <td>390</td>
      <td>68</td>
      <td>None</td>
      <td>183</td>
    </tr>
    <tr>
      <th>2</th>
      <td>576460752722405178</td>
      <td>1539621.375</td>
      <td>377</td>
      <td>70</td>
      <td>None</td>
      <td>203</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="population-level-morphological-analysis">
<h3>Population-Level Morphological Analysis<a class="headerlink" href="#population-level-morphological-analysis" title="Link to this heading">#</a></h3>
<p>Letâ€™s analyze morphology across a population of neurons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a larger sample of neurons</span>
<span class="n">opn_sample</span> <span class="o">=</span> <span class="n">opn_ids</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>

<span class="c1"># Get L2 info (fast morphology estimate)</span>
<span class="n">population_l2_info</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_info</span><span class="p">(</span><span class="n">opn_sample</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Population morphology statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cable length (Î¼m):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std: </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Range: </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">L2 chunks:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;l2_chunks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Range: </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;l2_chunks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;l2_chunks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Population morphology statistics:

Cable length (Î¼m):
  Mean: 53.39
  Std: 16.61
  Range: 28.83 - 105.19

L2 chunks:
  Mean: 406
  Range: 220 - 795
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize population morphology distribution</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Cable length distribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Cable Length (Î¼m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cable Length Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># L2 chunks vs cable length</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;l2_chunks&#39;</span><span class="p">],</span> <span class="n">population_l2_info</span><span class="p">[</span><span class="s1">&#39;length_um&#39;</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of L2 Chunks&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cable Length (Î¼m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;L2 Chunks vs Cable Length&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/79568167f1f38865796c33fbef7e5cda1a3e37bb0520ad618cca908991654ca7.png" src="../_images/79568167f1f38865796c33fbef7e5cda1a3e37bb0520ad618cca908991654ca7.png" />
</div>
</div>
</section>
<section id="comparing-cell-types">
<h3>Comparing Cell Types<a class="headerlink" href="#comparing-cell-types" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare morphology across different cell classes</span>
<span class="n">er_neurons</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">NeuronCriteria</span><span class="p">(</span><span class="n">cell_class</span><span class="o">=</span><span class="s1">&#39;ER&#39;</span><span class="p">)</span>
<span class="n">er_ids</span> <span class="o">=</span> <span class="n">er_neurons</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]</span>

<span class="c1"># Get L2 info for both populations</span>
<span class="n">opn_morph</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_info</span><span class="p">(</span><span class="n">opn_sample</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">opn_morph</span><span class="p">[</span><span class="s1">&#39;cell_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;OPN&#39;</span>

<span class="n">er_morph</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_info</span><span class="p">(</span><span class="n">er_ids</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">er_morph</span><span class="p">[</span><span class="s1">&#39;cell_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ER&#39;</span>

<span class="c1"># Combine</span>
<span class="n">combined_morph</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">opn_morph</span><span class="p">,</span> <span class="n">er_morph</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cable length statistics by cell class:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">combined_morph</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cell_class&#39;</span><span class="p">)[</span><span class="s1">&#39;length_um&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

<span class="c1"># plot the distribution of cable lengths by cell class</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;cell_class&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;length_um&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">combined_morph</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;Set2&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cable Length Distribution by Cell Class&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cell Class&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cable Length (Î¼m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                                                                 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cable length statistics by cell class:
            count     mean        std     min       25%      50%      75%  \
cell_class                                                                  
ER           20.0  17.4658   2.524752  13.349  15.96050  16.9815  19.0910   
OPN          20.0  53.3934  16.605328  28.827  45.23075  51.0715  58.7805   

                max  
cell_class           
ER           23.053  
OPN         105.185  
</pre></div>
</div>
<img alt="../_images/76138b70860e61c99556695ad28afc3116e7d7e0c9e55c15e0fa041bd9a709d1.png" src="../_images/76138b70860e61c99556695ad28afc3116e7d7e0c9e55c15e0fa041bd9a709d1.png" />
</div>
</div>
</section>
</section>
<section id="advanced-navis-integration">
<h2>7. Advanced Navis Integration<a class="headerlink" href="#advanced-navis-integration" title="Link to this heading">#</a></h2>
<p>CRANTpy neurons are fully compatible with navis, enabling access to its extensive analysis toolkit.</p>
<section id="resampling">
<h3>Resampling<a class="headerlink" href="#resampling" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resample skeleton to uniform spacing</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">resampled</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">resample_skeleton</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">resample_to</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># 1 micron spacing</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resampling:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Original nodes: </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Resampled nodes: </span><span class="si">{</span><span class="n">resampled</span><span class="o">.</span><span class="n">n_nodes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Original cable length: </span><span class="si">{</span><span class="n">original</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Resampled cable length: </span><span class="si">{</span><span class="n">resampled</span><span class="o">.</span><span class="n">cable_length</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Resampling:
  Original nodes: 309
  Resampled nodes: 1317
  Original cable length: 1409182.00 Î¼m
  Resampled cable length: 1402008.00 Î¼m
</pre></div>
</div>
</div>
</div>
</section>
<section id="smoothing">
<h3>Smoothing<a class="headerlink" href="#smoothing" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Smooth skeleton</span>
<span class="n">smoothed</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">smooth_skeleton</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># Visualize original vs smoothed</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">smoothed</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Smoothed&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d44bf14cd2a8456a834dd76aef93365a", "version_major": 2, "version_minor": 0}</script><img alt="../_images/b59ce94cd868f56eeab57cf660f1c8c8516d481215c6970cbe49768451f42951.png" src="../_images/b59ce94cd868f56eeab57cf660f1c8c8516d481215c6970cbe49768451f42951.png" />
</div>
</div>
</section>
<section id="trim-branches">
<h3>Trim branches<a class="headerlink" href="#trim-branches" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># trim branches shorter than a threshold</span>
<span class="n">trimmed</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">prune_twigs</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="o">*</span><span class="n">SCALE_X</span><span class="p">)</span>
<span class="c1"># Visualize original vs trimmed</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Original&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">trimmed</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Trimmed (&lt;2Î¼m branches removed)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7a08acbdbda442fef2177754fd0eb8a5d181c7875ed72d05912603cd3380c6c9.png" src="../_images/7a08acbdbda442fef2177754fd0eb8a5d181c7875ed72d05912603cd3380c6c9.png" />
</div>
</div>
</section>
<section id="neuron-similarity-nblast">
<h3>Neuron Similarity (NBLAST)<a class="headerlink" href="#neuron-similarity-nblast" title="Link to this heading">#</a></h3>
<p>NBLAST is a powerful algorithm for quantifying morphological similarity between neurons. It operates on dotprops representations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the dotprops for 30 neurons</span>
<span class="n">dotprops</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">get_l2_dotprops</span><span class="p">(</span>
    <span class="n">opn_ids</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span>
    <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">omit_failures</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">/</span><span class="mi">1000</span> <span class="c1"># scale to microns</span>


<span class="c1"># NBLAST requires dotprops</span>
<span class="c1"># Compute pairwise similarity</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">nblast</span><span class="p">(</span><span class="n">dotprops</span><span class="p">,</span> <span class="n">dotprops</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Visualize similarity matrix</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;NBLAST Similarity Matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Neuron Index&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Neuron Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Normalized Score&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Find most similar pair</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Exclude self-comparisons</span>
<span class="n">max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Most similar pair: neurons </span><span class="si">{</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity score: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">max_idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># plot the closest 10 pairs</span>
<span class="n">closest_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">scores</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span> <span class="n">scores</span><span class="o">.</span><span class="n">shape</span><span class="p">))[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">closest_pairs</span><span class="p">):</span>
    <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">dotprops</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
    <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">dotprops</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;coral&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Neurons </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> &amp; </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1"> (Score: </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8c028cac85f7400b87d92c7a9b7ba3a0", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "60cb624243db42bb87088f88e7485d4f", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "28ab66dedcbf4a6ab9d71eb867faa379", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "22aa8716e5bc4c4cb374745f53f0575d", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "71392cd163cb4c19a6ab72ce9cede499", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "9442d2223a83453cb5c1f7a6a888adad", "version_major": 2, "version_minor": 0}</script><img alt="../_images/90c1810a523efebf05609f96def0fe0dcc7464fce4581d261cdec8796b86a245.png" src="../_images/90c1810a523efebf05609f96def0fe0dcc7464fce4581d261cdec8796b86a245.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Most similar pair: neurons 2 and 1
Similarity score: 0.427
</pre></div>
</div>
<img alt="../_images/4326ee5691c84fa075d62509984cd006c9443138937f3699bbcf6ea50262bf00.png" src="../_images/4326ee5691c84fa075d62509984cd006c9443138937f3699bbcf6ea50262bf00.png" />
</div>
</div>
</section>
</section>
<section id="distance-calculations">
<h2>8. Distance Calculations<a class="headerlink" href="#distance-calculations" title="Link to this heading">#</a></h2>
<p>Understanding distances within neurons is crucial for many analyses. Weâ€™ll explore both Euclidean (straight-line) and geodesic (along-the-arbor) distances.</p>
<section id="sampling-rate-node-to-parent-distances">
<h3>Sampling Rate (Node-to-Parent Distances)<a class="headerlink" href="#sampling-rate-node-to-parent-distances" title="Link to this heading">#</a></h3>
<p>First, letâ€™s calculate the average distance between nodes and their parents - this tells us about the skeletonâ€™s sampling rate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">skel</span> <span class="o">=</span> <span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Get nodes but remove the root (has no parent)</span>
<span class="n">nodes</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Get the x/y/z coordinates of all nodes (except root)</span>
<span class="n">node_locs</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># For each node, get its parent&#39;s location</span>
<span class="n">parent_locs</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Calculate Euclidean distances</span>
<span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">node_locs</span> <span class="o">-</span> <span class="n">parent_locs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sampling rate statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean distance between nodes: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm&quot;</span><span class="p">)</span>

<span class="c1"># Plot distribution</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance to Parent Node (nm)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Skeleton Sampling Rate Distribution&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> nm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling rate statistics:
  Mean distance between nodes: 4575.27 nm
  Std: 3191.86 nm
  Median: 4793.04 nm
</pre></div>
</div>
<img alt="../_images/b3944b246e8fc06e1e0e504e8152ef19522cc87bbae975b5fc2d12f343157705.png" src="../_images/b3944b246e8fc06e1e0e504e8152ef19522cc87bbae975b5fc2d12f343157705.png" />
</div>
</div>
</section>
<section id="geodesic-distance-single-node-to-node-query">
<h3>Geodesic Distance: Single Node-to-Node Query<a class="headerlink" href="#geodesic-distance-single-node-to-node-query" title="Link to this heading">#</a></h3>
<p>For distances along the neuronâ€™s branching structure, we need geodesic distances. Letâ€™s calculate the distance from the soma (root) to a terminal node:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pick a terminal node</span>
<span class="n">end_nodes</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">values</span>
<span class="n">terminal_node</span> <span class="o">=</span> <span class="n">end_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Calculate geodesic distance from root to terminal node</span>
<span class="n">d_geo</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">dist_between</span><span class="p">(</span><span class="n">skel</span><span class="p">,</span> <span class="n">skel</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">terminal_node</span><span class="p">)</span>

<span class="c1"># Also calculate Euclidean distance for comparison</span>
<span class="n">end_loc</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">terminal_node</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">root_loc</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">skel</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
<span class="n">d_eucl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">end_loc</span> <span class="o">-</span> <span class="n">root_loc</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance from root to terminal node </span><span class="si">{</span><span class="n">terminal_node</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Geodesic (along arbor): </span><span class="si">{</span><span class="n">d_geo</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm (</span><span class="si">{</span><span class="n">d_geo</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Euclidean (straight line): </span><span class="si">{</span><span class="n">d_eucl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> nm (</span><span class="si">{</span><span class="n">d_eucl</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ratio (tortuosity): </span><span class="si">{</span><span class="n">d_geo</span><span class="o">/</span><span class="n">d_eucl</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distance from root to terminal node 5:
  Geodesic (along arbor): 307062.21 nm (307.06 Î¼m)
  Euclidean (straight line): 197367.96 nm (197.37 Î¼m)
  Ratio (tortuosity): 1.56x
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the difference between geodesic and Euclidean distances</span>

<span class="c1"># Find the shortest path along the skeleton</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">skel</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">to_undirected</span><span class="p">(),</span> <span class="n">skel</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">terminal_node</span><span class="p">)</span>

<span class="c1"># Get coordinates for the path</span>
<span class="n">path_co</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Plot the neuron</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">skel</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Add geodesic path (along the skeleton)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">path_co</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">path_co</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Geodesic path&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Add Euclidean path (straight line)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> 
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Euclidean path&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Mark root and terminal node</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">root_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Root (soma)&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">end_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> 
           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Terminal node&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Add text annotations</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">root_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39; Root&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">end_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39; Terminal&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>   

<span class="c1"># add distance annotations</span>
<span class="n">mid_geo</span> <span class="o">=</span> <span class="n">path_co</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">path_co</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>
<span class="n">mid_eucl</span> <span class="o">=</span> <span class="p">[(</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">root_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">end_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mid_geo</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">mid_geo</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">d_geo</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Î¼m&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">mid_eucl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mid_eucl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">d_eucl</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Î¼m&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>        

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Geodesic vs Euclidean Distance&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/95449878474fedc220b84e1b1b789afb3364ad61ed8e9d0fda1edd0c4144537c.png" src="../_images/95449878474fedc220b84e1b1b789afb3364ad61ed8e9d0fda1edd0c4144537c.png" />
</div>
</div>
</section>
<section id="geodesic-distance-matrix">
<h3>Geodesic Distance Matrix<a class="headerlink" href="#geodesic-distance-matrix" title="Link to this heading">#</a></h3>
<p>For analyzing distances across many nodes, we can use <code class="docutils literal notranslate"><span class="pre">navis.geodesic_matrix()</span></code> to compute a distance matrix. Letâ€™s calculate distances between all terminal nodes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate distances from all end nodes to all other nodes</span>
<span class="n">ends</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating geodesic distances for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span><span class="si">}</span><span class="s2"> terminal nodes...&quot;</span><span class="p">)</span>

<span class="c1"># Get the distance matrix</span>
<span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">geodesic_matrix</span><span class="p">(</span><span class="n">skel</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">ends</span><span class="p">)</span>

<span class="c1"># Subset to only end-to-end distances</span>
<span class="n">dist_matrix_ends</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ends</span><span class="p">,</span> <span class="n">ends</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distance matrix shape: </span><span class="si">{</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance statistics (Î¼m):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculating geodesic distances for 97 terminal nodes...

Distance matrix shape: (97, 97)
Distance statistics (Î¼m):
  Mean: 194.81
  Median: 219.03
  Max: 379.44
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>44</th>
      <th>12</th>
      <th>19</th>
      <th>10</th>
      <th>39</th>
      <th>42</th>
      <th>...</th>
      <th>286</th>
      <th>282</th>
      <th>281</th>
      <th>289</th>
      <th>290</th>
      <th>304</th>
      <th>301</th>
      <th>307</th>
      <th>305</th>
      <th>306</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>5</th>
      <td>0.000000</td>
      <td>1470.138794</td>
      <td>21770.945312</td>
      <td>21924.505859</td>
      <td>43284.164062</td>
      <td>82830.328125</td>
      <td>68335.960938</td>
      <td>162903.531250</td>
      <td>155059.750000</td>
      <td>97709.773438</td>
      <td>...</td>
      <td>196621.8750</td>
      <td>194101.625000</td>
      <td>194177.703125</td>
      <td>213741.078125</td>
      <td>215143.28125</td>
      <td>214334.812500</td>
      <td>206430.062500</td>
      <td>228993.875000</td>
      <td>230859.656250</td>
      <td>229488.406250</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1470.138794</td>
      <td>0.000000</td>
      <td>21653.496094</td>
      <td>21807.058594</td>
      <td>43166.718750</td>
      <td>82712.882812</td>
      <td>68218.515625</td>
      <td>162786.093750</td>
      <td>154942.312500</td>
      <td>97592.328125</td>
      <td>...</td>
      <td>196504.4375</td>
      <td>193984.187500</td>
      <td>194060.265625</td>
      <td>213623.640625</td>
      <td>215025.84375</td>
      <td>214217.375000</td>
      <td>206312.625000</td>
      <td>228876.437500</td>
      <td>230742.218750</td>
      <td>229370.968750</td>
    </tr>
    <tr>
      <th>7</th>
      <td>21770.945312</td>
      <td>21653.496094</td>
      <td>0.000000</td>
      <td>963.262634</td>
      <td>22322.921875</td>
      <td>61869.085938</td>
      <td>47374.718750</td>
      <td>141942.296875</td>
      <td>134098.500000</td>
      <td>76748.531250</td>
      <td>...</td>
      <td>175660.6250</td>
      <td>173140.375000</td>
      <td>173216.468750</td>
      <td>192779.843750</td>
      <td>194182.03125</td>
      <td>193373.578125</td>
      <td>185468.812500</td>
      <td>208032.625000</td>
      <td>209898.406250</td>
      <td>208527.156250</td>
    </tr>
    <tr>
      <th>8</th>
      <td>21924.505859</td>
      <td>21807.058594</td>
      <td>963.262634</td>
      <td>0.000000</td>
      <td>22476.482422</td>
      <td>62022.648438</td>
      <td>47528.281250</td>
      <td>142095.859375</td>
      <td>134252.062500</td>
      <td>76902.093750</td>
      <td>...</td>
      <td>175814.1875</td>
      <td>173293.937500</td>
      <td>173370.031250</td>
      <td>192933.406250</td>
      <td>194335.59375</td>
      <td>193527.140625</td>
      <td>185622.375000</td>
      <td>208186.187500</td>
      <td>210051.968750</td>
      <td>208680.718750</td>
    </tr>
    <tr>
      <th>44</th>
      <td>43284.164062</td>
      <td>43166.718750</td>
      <td>22322.921875</td>
      <td>22476.482422</td>
      <td>0.000000</td>
      <td>58810.382812</td>
      <td>44316.015625</td>
      <td>138883.593750</td>
      <td>131039.796875</td>
      <td>73689.828125</td>
      <td>...</td>
      <td>172601.9375</td>
      <td>170081.671875</td>
      <td>170157.750000</td>
      <td>189721.125000</td>
      <td>191123.34375</td>
      <td>190314.875000</td>
      <td>182410.109375</td>
      <td>204973.921875</td>
      <td>206839.703125</td>
      <td>205468.453125</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 97 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the distance matrix with hierarchical clustering</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.cluster.hierarchy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linkage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">squareform</span>

<span class="c1"># Generate linkage from the distances</span>
<span class="n">Z</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">squareform</span><span class="p">(</span><span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">checks</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>

<span class="c1"># Create clustermap</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span>
    <span class="n">dist_matrix_ends</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># Convert to microns</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
    <span class="n">col_linkage</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
    <span class="n">row_linkage</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span>
    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Distance (Î¼m)&#39;</span><span class="p">},</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">cm</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Terminal Node&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cm</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Terminal Node&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">cm</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Geodesic Distances Between Terminal Nodes&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>

<span class="c1"># Remove tick labels for cleaner look</span>
<span class="n">cm</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
<span class="n">cm</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: Clustering in the heatmap can reveal dendritic vs axonal compartments!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nodes that cluster together are likely in the same compartment.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 1000x800 with 0 Axes&gt;
</pre></div>
</div>
<img alt="../_images/7eca928baf396ee7eb02a72b32993360d00cf4befd1d749600bd735c99b07e8c.png" src="../_images/7eca928baf396ee7eb02a72b32993360d00cf4befd1d749600bd735c99b07e8c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: Clustering in the heatmap can reveal dendritic vs axonal compartments!
Nodes that cluster together are likely in the same compartment.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the clusters and plot them on the neuron</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.cluster.hierarchy</span><span class="w"> </span><span class="kn">import</span> <span class="n">fcluster</span>
<span class="c1"># Cut the dendrogram to form 2 clusters</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">fcluster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">&#39;maxclust&#39;</span><span class="p">)</span>

<span class="c1"># plot all the nodes colored by cluster</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span><span class="n">skel</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">node_colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">clusters</span><span class="p">))</span><span class="o">.</span><span class="n">as_hex</span><span class="p">()</span>
<span class="n">node_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_colors</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ends</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;node_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ends</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">node_colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Terminal Nodes&#39;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Terminal Nodes Colored by Cluster&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/49a895ebbae90e8e44f83843e18397611d8ca818361659bea863e94b7a920b70.png" src="../_images/49a895ebbae90e8e44f83843e18397611d8ca818361659bea863e94b7a920b70.png" />
</div>
</div>
</section>
<section id="distance-based-node-coloring">
<h3>Distance-based Node Coloring<a class="headerlink" href="#distance-based-node-coloring" title="Link to this heading">#</a></h3>
<p>We can also use distances to color the neuron, highlighting how far each node is from the root:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate distance from root to all nodes</span>
<span class="n">root_node</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">all_node_ids</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">node_id</span><span class="o">.</span><span class="n">values</span>
<span class="n">distances_all</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">geodesic_matrix</span><span class="p">(</span><span class="n">skel</span><span class="p">,</span> <span class="n">from_</span><span class="o">=</span><span class="n">all_node_ids</span><span class="p">)</span>

<span class="c1"># Add to nodes dataframe</span>
<span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distances_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">root_node</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># set nan to 0 </span>
<span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distance from root statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std: </span><span class="si">{</span><span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Î¼m&quot;</span><span class="p">)</span>

<span class="c1"># Plot neuron colored by distance from root</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># View 1: X-Y</span>
<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span>
    <span class="n">skel</span><span class="p">,</span>
    <span class="n">color_by</span><span class="o">=</span><span class="s1">&#39;root_dist&#39;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span>
    <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># plot the root</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">root_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Root&#39;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distance from Root (X-Y view)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="c1"># View 2: X-Z</span>
<span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span>
    <span class="n">skel</span><span class="p">,</span>
    <span class="n">color_by</span><span class="o">=</span><span class="s1">&#39;root_dist&#39;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span>
    <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># plot the root</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">root_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">root_loc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Root&#39;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distance from Root (X-Z view)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="c1"># add colorbar</span>
<span class="n">minimum</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">minimum</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maximum</span><span class="p">)),</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">inset_axes</span><span class="p">([</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Distance from Root (nm)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distance from root statistics:
  Mean: 236.91 Î¼m
  Max: 374.03 Î¼m
  Std: 101.03 Î¼m
</pre></div>
</div>
<img alt="../_images/a5c7f1eddf08441ea325791d1e50147238fab89ea1009b3e9622d966234310e9.png" src="../_images/a5c7f1eddf08441ea325791d1e50147238fab89ea1009b3e9622d966234310e9.png" />
</div>
</div>
</section>
</section>
<section id="advanced-morphometric-analysis">
<h2>9. Advanced Morphometric Analysis<a class="headerlink" href="#advanced-morphometric-analysis" title="Link to this heading">#</a></h2>
<section id="segment-analysis">
<h3>Segment Analysis<a class="headerlink" href="#segment-analysis" title="Link to this heading">#</a></h3>
<p>Navis provides <code class="docutils literal notranslate"><span class="pre">segment_analysis()</span></code> which collects comprehensive morphometrics for each linear segment (between branch points), including Strahler index, cable length, distance to root, and tortuosity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform comprehensive segment analysis</span>
<span class="n">seg_analysis</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">segment_analysis</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segment analysis results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total segments: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seg_analysis</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First few segments:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">seg_analysis</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Summary statistics:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">seg_analysis</span><span class="p">[[</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;tortuosity&#39;</span><span class="p">,</span> <span class="s1">&#39;root_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;strahler_index&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Segment analysis results:
  Total segments: 152

First few segments:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>length</th>
      <th>tortuosity</th>
      <th>root_dist</th>
      <th>strahler_index</th>
      <th>radius_mean</th>
      <th>radius_min</th>
      <th>radius_max</th>
      <th>volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>793.792721</td>
      <td>1.009957</td>
      <td>306268.419732</td>
      <td>1</td>
      <td>221.333333</td>
      <td>193</td>
      <td>244</td>
      <td>1.326052e+08</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20572.301259</td>
      <td>1.093203</td>
      <td>285696.118473</td>
      <td>2</td>
      <td>271.000000</td>
      <td>193</td>
      <td>314</td>
      <td>5.024232e+09</td>
    </tr>
    <tr>
      <th>2</th>
      <td>676.346065</td>
      <td>1.000000</td>
      <td>306268.419732</td>
      <td>1</td>
      <td>191.000000</td>
      <td>189</td>
      <td>193</td>
      <td>7.751780e+07</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12285.961101</td>
      <td>1.034210</td>
      <td>273410.157373</td>
      <td>2</td>
      <td>212.750000</td>
      <td>117</td>
      <td>314</td>
      <td>9.929913e+08</td>
    </tr>
    <tr>
      <th>4</th>
      <td>404.850590</td>
      <td>1.000000</td>
      <td>285696.118473</td>
      <td>1</td>
      <td>243.000000</td>
      <td>172</td>
      <td>314</td>
      <td>7.724016e+07</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Summary statistics:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>length</th>
      <th>tortuosity</th>
      <th>root_dist</th>
      <th>strahler_index</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>152.000000</td>
      <td>152.000000</td>
      <td>152.000000</td>
      <td>152.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>9270.934315</td>
      <td>1.037665</td>
      <td>225768.867012</td>
      <td>1.513158</td>
    </tr>
    <tr>
      <th>std</th>
      <td>16940.222298</td>
      <td>0.100488</td>
      <td>106298.128510</td>
      <td>0.813681</td>
    </tr>
    <tr>
      <th>min</th>
      <td>55.172457</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1192.933156</td>
      <td>1.000000</td>
      <td>80607.110184</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>4983.385660</td>
      <td>1.000000</td>
      <td>265986.027429</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>10191.787491</td>
      <td>1.024821</td>
      <td>306346.790386</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>173550.345434</td>
      <td>1.788708</td>
      <td>360682.099962</td>
      <td>5.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize segment properties</span>
<span class="n">seg_analysis</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">segment_analysis</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Segment length distribution by Strahler order</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;strahler_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">seg_analysis</span><span class="p">[</span><span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;strahler_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">order</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Order </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Segment Length (Î¼m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Segment Length by Strahler Order&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Tortuosity vs distance from root</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;root_dist&#39;</span><span class="p">],</span> 
    <span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;tortuosity&#39;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;strahler_index&#39;</span><span class="p">],</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance from Root (Î¼m)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Tortuosity&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Tortuosity vs Root Distance&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Strahler Index&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/030e93667b4f8004f57ec469eec67fb8a7a3135bd9cc6b4d3993636f0d3357d8.png" src="../_images/030e93667b4f8004f57ec469eec67fb8a7a3135bd9cc6b4d3993636f0d3357d8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># compare strahler order counts between neurons</span>

<span class="c1"># calculate strahler order counts for each neuron</span>
<span class="n">strahler_counts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">skel</span> <span class="ow">in</span> <span class="n">l2_skels_rerooted</span><span class="p">:</span>
    <span class="n">seg_analysis</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">segment_analysis</span><span class="p">(</span><span class="n">skel</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">seg_analysis</span><span class="p">[</span><span class="s1">&#39;strahler_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">counts</span><span class="p">[</span><span class="s1">&#39;root_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skel</span><span class="o">.</span><span class="n">id</span>
    <span class="n">strahler_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
<span class="n">strahler_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">strahler_counts</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;root_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># show as a heatmap</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">strahler_df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Segment Count&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Strahler Order Counts per Neuron&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Strahler Order&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Neuron ID&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/190edd94fd52f4240c6a7fd1ea10f3ce6c1118c68b7944871238a32354e9b63b.png" src="../_images/190edd94fd52f4240c6a7fd1ea10f3ce6c1118c68b7944871238a32354e9b63b.png" />
</div>
</div>
</section>
<section id="visualizing-node-properties">
<h3>Visualizing Node Properties<a class="headerlink" href="#visualizing-node-properties" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add strahler index to skeleton nodes</span>
<span class="n">navis</span><span class="o">.</span><span class="n">strahler_index</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># Color by Strahler order</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">plot2d</span><span class="p">(</span>
    <span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">view</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
    <span class="n">color_by</span><span class="o">=</span><span class="s1">&#39;strahler_index&#39;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Colored by Strahler Order&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/55101d0fe1d97cf6ee08daf88d90c10a433002a3371a8659beba0b7844eb6502.png" src="../_images/55101d0fe1d97cf6ee08daf88d90c10a433002a3371a8659beba0b7844eb6502.png" />
</div>
</div>
</section>
<section id="sholl-analysis">
<h3>Sholl analysis<a class="headerlink" href="#sholl-analysis" title="Link to this heading">#</a></h3>
<p>Sholl analysis quantifies branching complexity as a function of distance from the soma.</p>
<section id="euclidean-distance-from-soma">
<h4>Euclidean distance from soma<a class="headerlink" href="#euclidean-distance-from-soma" title="Link to this heading">#</a></h4>
<p>Typically, Sholl analysis is performed using Euclidean distance from the soma.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform sholl analysis with euclidean radii of 50 nm increments from the root</span>
<span class="n">sholl_results</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">sholl_analysis</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radii</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># plot sholl results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;intersections&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Intersections&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;branch_points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Branch Points&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;cable_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cable Length (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sholl Analysis&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>intersections</th>
      <th>cable_length</th>
      <th>branch_points</th>
    </tr>
    <tr>
      <th>radius</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4283.629551</th>
      <td>0</td>
      <td>0.000000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8567.259101</th>
      <td>0</td>
      <td>13065.068359</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12850.888652</th>
      <td>0</td>
      <td>0.000000</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17134.518202</th>
      <td>0</td>
      <td>9701.698242</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21418.147753</th>
      <td>0</td>
      <td>3230.100830</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/aca454350b915b4a39d6e64cd08f4282ae9e72e84bd4e700ed4b3f1ea8b0c274.png" src="../_images/aca454350b915b4a39d6e64cd08f4282ae9e72e84bd4e700ed4b3f1ea8b0c274.png" />
</div>
</div>
</section>
<section id="geodesic-distance-from-soma">
<h4>Geodesic distance from soma<a class="headerlink" href="#geodesic-distance-from-soma" title="Link to this heading">#</a></h4>
<p>Sholl analysis can also be performed using geodesic distance along the neuron structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># perform sholl analysis with euclidean radii of 50 nm increments from the root</span>
<span class="n">sholl_results</span> <span class="o">=</span> <span class="n">navis</span><span class="o">.</span><span class="n">sholl_analysis</span><span class="p">(</span><span class="n">l2_skels_rerooted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radii</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">geodesic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># plot sholl results</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;intersections&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Intersections&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;branch_points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Branch Points&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sholl_results</span><span class="o">.</span><span class="n">index</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">sholl_results</span><span class="p">[</span><span class="s1">&#39;cable_length&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Cable Length (um)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sholl Analysis&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>intersections</th>
      <th>cable_length</th>
      <th>branch_points</th>
    </tr>
    <tr>
      <th>radius</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>7480.571289</th>
      <td>0</td>
      <td>5413.287598</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14961.142578</th>
      <td>0</td>
      <td>14514.019531</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22441.714844</th>
      <td>0</td>
      <td>6069.560547</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29922.285156</th>
      <td>0</td>
      <td>6710.543457</td>
      <td>0</td>
    </tr>
    <tr>
      <th>37402.855469</th>
      <td>0</td>
      <td>8032.163574</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="../_images/146fe5ad28271b41d952041b72d51b7029a693ebee9d7797ae3aa04e7f7cf2bf.png" src="../_images/146fe5ad28271b41d952041b72d51b7029a693ebee9d7797ae3aa04e7f7cf2bf.png" />
</div>
</div>
</section>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>In this comprehensive deep dive, you learned:</p>
<p>âœ… <strong>Mesh representations</strong> - Fetching and analyzing neuron surface meshes<br />
âœ… <strong>Skeleton representations</strong> - Multiple methods (precomputed, L2-based)<br />
âœ… <strong>L2 graph analysis</strong> - High-quality morphology from L2 chunks<br />
âœ… <strong>Dotprops</strong> - Lightweight representations for fast comparisons<br />
âœ… <strong>Morphometric analysis</strong> - Cable length, branching, Strahler order, tortuosity<br />
âœ… <strong>Soma detection</strong> - Automated identification from mesh and skeleton data<br />
âœ… <strong>Visualization</strong> - 2D, 3D, and property-based coloring<br />
âœ… <strong>Population analysis</strong> - Comparing morphology across neuron groups<br />
âœ… <strong>Navis integration</strong> - Advanced analysis (NBLAST, resampling, smoothing)</p>
<section id="key-takeaways">
<h3>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p><strong>Choose the right representation</strong>: Meshes for detail, skeletons for analysis, dotprops for comparison</p></li>
<li><p><strong>L2-based morphology</strong>: Often more accurate than precomputed data</p></li>
<li><p><strong>Fast estimates</strong>: Use <code class="docutils literal notranslate"><span class="pre">get_l2_info()</span></code> for quick morphology overview</p></li>
<li><p><strong>Leverage navis</strong>: Full access to navisâ€™s morphometric toolkit</p></li>
<li><p><strong>Population studies</strong>: Compare morphology across cell types and conditions</p></li>
</ol>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./deep_dive"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="visualization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Deep Dive: Plotting Neurons</p>
      </div>
    </a>
    <a class="right-next"
       href="connectivity.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Deep Dive: Analyzing Connectivity</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-setup">1. Authentication Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-sample-neurons">2. Getting Sample Neurons</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mesh-representations">3. Mesh Representations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-mesh-neurons">Fetching Mesh Neurons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soma-detection">Soma Detection</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#skeleton-representations">4. Skeleton Representations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#precomputed-skeletons">Precomputed Skeletons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l2-graph-based-skeletons">L2 Graph-Based Skeletons</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#l2-information-and-statistics">L2 Information and Statistics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-anchor-locations">Finding Anchor Locations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rerooting-skeletons-to-the-soma">Rerooting Skeletons to the Soma</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#utility-functions-for-spatial-operations">Utility Functions for Spatial Operations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dotprops-point-cloud-representations">5. Dotprops - Point Cloud Representations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#morphometric-analysis">6. Morphometric Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-morphometrics">Basic Morphometrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#population-level-morphological-analysis">Population-Level Morphological Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-cell-types">Comparing Cell Types</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-navis-integration">7. Advanced Navis Integration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resampling">Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smoothing">Smoothing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trim-branches">Trim branches</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#neuron-similarity-nblast">Neuron Similarity (NBLAST)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-calculations">8. Distance Calculations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-rate-node-to-parent-distances">Sampling Rate (Node-to-Parent Distances)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-single-node-to-node-query">Geodesic Distance: Single Node-to-Node Query</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-matrix">Geodesic Distance Matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-node-coloring">Distance-based Node Coloring</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-morphometric-analysis">9. Advanced Morphometric Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#segment-analysis">Segment Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-node-properties">Visualizing Node Properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sholl-analysis">Sholl analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#euclidean-distance-from-soma">Euclidean distance from soma</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#geodesic-distance-from-soma">Geodesic distance from soma</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By CRANTb Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>